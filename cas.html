<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cellular Automata Sequencer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { font-family: 'Courier New', monospace; background: #050505; color: #ddd; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .controls { width: 400px; background: #151515; padding: 20px; border: 1px solid #333; }
        canvas { border: 1px solid #333; background: #000; }
        
        button { width: 100%; padding: 15px; background: #222; color: #fff; border: 1px solid #444; cursor: pointer; font-weight: bold; margin-bottom: 15px; }
        button:hover { background: #333; }
        button.active { background: #00aa00; border-color: #00aa00; color: #000; }
        
        .slider-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 11px; color: #888; }
        input[type=range] { width: 60%; cursor: pointer; accent-color: #00aa00; }
        
        .ir-loader { border: 1px dashed #444; padding: 10px; text-align: center; margin-bottom: 15px; }
        .ir-loader p { margin: 0 0 5px 0; font-size: 10px; color: #666; }
        
        /* Track Rows */
        .track-row { 
            display: grid; grid-template-columns: 15px 50px 1fr; align-items: center; gap: 10px;
            padding: 5px 0; border-bottom: 1px solid #222; font-size: 11px;
        }
        .track-color { width: 10px; height: 10px; }
        input[type="file"] { font-size: 9px; color: #555; }
        input[type="file"]::file-selector-button { background: #222; border: 1px solid #444; color: #ddd; cursor:pointer; }
    </style>
</head>
<body>

    <h1>Cellular Automata Sequencer</h1>
    
    <div style="position:relative;">
        <canvas id="historyCanvas" width="600" height="400"></canvas>
        <div id="beatMarker" style="position:absolute; top:0; left:0; width:37px; height:100%; background:rgba(255,255,255,0.1); border-left:1px solid rgba(255,255,255,0.3); pointer-events:none;"></div>
    </div>

    <div class="controls">
        <button id="playBtn">â–¶ START ENGINE</button>
        
        <div class="ir-loader">
            <p>1. LOAD IMPULSE RESPONSE (OPTIONAL)</p>
            <input type="file" id="irInput" accept="audio/*">
            <p id="irStatus" style="color:#00aa00; margin-top:5px; display:none;">IR LOADED</p>
        </div>

        <div class="slider-row">
            <label>REVERB VOL</label>
            <input type="range" id="sldRev" min="0" max="2" step="0.05" value="0.5">
        </div>
        <div class="slider-row">
            <label>CHAOS</label>
            <input type="range" id="sldLam" min="0" max="1" step="0.01" value="0.42">
        </div>
        <div class="slider-row">
            <label>GLITCH</label>
            <input type="range" id="sldRatch" min="0" max="0.8" step="0.01" value="0.25">
        </div>
        <div class="slider-row">
            <label>TEMPO</label>
            <input type="range" id="sldBpm" min="60" max="300" step="1" value="120">
        </div>
        
        <button onclick="scramble()" style="background:#522; border-color:#844; font-size:11px; margin-top:10px;">ðŸŽ² SCRAMBLE</button>
        
        <div id="trackList" style="margin-top:10px;"></div>
    </div>

<script>
// --- CONFIG ---
const STEPS = 16;
const STATES = 8;
const NEIGHBORS = 3;
const RULE_SIZE = Math.pow(STATES, NEIGHBORS);
const RATCHET_MAP = { 0:0, 1:1, 2:2, 3:4, 4:8, 5:16, 6:32, 7:6 };

let params = { lambda: 0.42, ratchet: 0.25, reverb: 0.5, bpm: 120, density: 0.2 };

const tracks = [
    { id: 0, name: 'KICK', color: '#f44' }, { id: 1, name: 'SNARE', color: '#4f4' },
    { id: 2, name: 'HAT', color: '#44f' },  { id: 3, name: 'HAT2', color: '#0ff' },
    { id: 4, name: 'CLAP', color: '#f0f' }, { id: 5, name: 'PERC', color: '#ff0' },
    { id: 6, name: 'GLITCH',color: '#f80' },{ id: 7, name: 'NOISE', color: '#ccc' }
];

tracks.forEach(t => {
    t.world = new Uint8Array(STEPS);
    t.rule = new Uint8Array(RULE_SIZE);
    t.ruleUsed = new Uint8Array(RULE_SIZE);
    t.lambdaPath = [];
    t.player = null; 
});

// --- AUDIO GLOBALS ---
let actx;           
let convolverNode;  
let reverbGain;     
let isPlaying = false;
let currentStep = 0;

// --- CA LOGIC ---
function randInt(min, max) { return Math.floor(Math.random()*(max-min+1))+min; }
function getRandomState() {
    let r = Math.random();
    if (r > params.ratchet) return 1; 
    let r2 = Math.random();
    if(r2 < 0.4) return 2; if(r2 < 0.7) return 3; if(r2 < 0.85) return 4;
    if(r2 < 0.95) return 7; return 6; 
}

function initTrack(t) {
    t.world.fill(0); t.world[8] = 1; 
    for(let i=0; i<STEPS; i++) if(Math.random()<params.density) t.world[i] = getRandomState();
    t.rule[0] = 0; for(let i=1; i<RULE_SIZE; i++) t.rule[i] = getRandomState();
    let idx = Array.from({length:RULE_SIZE-1},(_,k)=>k+1);
    for(let i=idx.length-1; i>0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [idx[i],idx[j]] = [idx[j],idx[i]];
    }
    t.lambdaPath = idx;
    applyLambda(t);
}

function applyLambda(t) {
    let count = Math.floor(params.lambda * t.lambdaPath.length);
    t.ruleUsed.fill(0);
    for(let i=0; i<count; i++) t.ruleUsed[t.lambdaPath[i]] = 1;
}

function evolve(t) {
    let next = new Uint8Array(STEPS);
    let off = Math.floor(NEIGHBORS/2);
    for(let i=0; i<STEPS; i++) {
        let code = 0;
        for(let n=0; n<NEIGHBORS; n++) {
            let idx = (i+n-off+STEPS)%STEPS;
            code = code*STATES + t.world[idx];
        }
        next[i] = t.ruleUsed[code] ? t.rule[code] : 0;
    }
    t.world = next;
}

// --- AUDIO ENGINE ---
async function initAudio() {
    if(isPlaying) return;
    
    await Tone.start();
    actx = Tone.context.rawContext; 
    
    // NATIVE REVERB CHAIN (Parallel Bus)
    if(!convolverNode) {
        convolverNode = actx.createConvolver();
        reverbGain = actx.createGain();
        reverbGain.gain.value = params.reverb;
        
        convolverNode.connect(reverbGain);
        reverbGain.connect(actx.destination);
        
        // Generate Default Digital Reverb Buffer
        const rate = actx.sampleRate;
        const length = rate * 2.0;
        const impulse = actx.createBuffer(2, length, rate);
        const L = impulse.getChannelData(0);
        const R = impulse.getChannelData(1);
        for (let i = 0; i < length; i++) {
            let decay = Math.pow(1 - i / length, 3);
            L[i] = (Math.random() * 2 - 1) * decay;
            R[i] = (Math.random() * 2 - 1) * decay;
        }
        convolverNode.buffer = impulse;
    }

    // CREATE INSTRUMENTS (Synths or Players)
    tracks.forEach((t, i) => {
        // If user hasn't loaded a sample, make a default synth
        if(!t.player) {
            t.player = createDefaultSynth(i);
        }
        // Ensure routing for whatever player exists
        connectRoute(t.player);
    });

    Tone.Transport.cancel();
    Tone.Transport.scheduleRepeat(loop, "16n");
    Tone.Transport.bpm.value = params.bpm;
    Tone.Transport.start();
    
    isPlaying = true;
    const btn = document.getElementById('playBtn');
    btn.innerText = "â–  STOP";
    btn.classList.add('active');
}

// HELPER: Connect any node (Synth or Player) to Dry + Wet
function connectRoute(node) {
    node.disconnect();
    // 1. Dry
    node.connect(actx.destination);
    // 2. Wet (Send to Convolver)
    node.connect(convolverNode);
}

function createDefaultSynth(i) {
    let s;
    if(i===0) s = new Tone.MembraneSynth({volume:-6});
    else if(i===1) s = new Tone.NoiseSynth({envelope:{decay:0.2}, volume:-8});
    else if(i===2) s = new Tone.MetalSynth({volume:-15, envelope:{decay:0.05}});
    else if(i===3) s = new Tone.MetalSynth({volume:-15, harmonicity:5, modulationIndex:20});
    else if(i===4) s = new Tone.NoiseSynth({volume:-10, noise:{type:'pink'}});
    else if(i===5) s = new Tone.MembraneSynth({volume:-10, pitchDecay:0.01});
    else if(i===6) s = new Tone.FMSynth({volume:-10, modulationIndex:10});
    else s = new Tone.PluckSynth({volume:-10});
    return s;
}

function loop(time) {
    tracks.forEach(t => {
        let state = t.world[currentStep];
        if(state > 0 && t.player) {
            let mult = RATCHET_MAP[state];
            let dur = Tone.Time("16n").toSeconds() / mult;
            
            for(let k=0; k<mult; k++) {
                let tTime = time + (k * dur);
                
                if(t.player instanceof Tone.Player) {
                    if(t.player.loaded) t.player.start(tTime);
                } else {
                    // Synth triggers
                    if(t.id===0) t.player.triggerAttackRelease("C1", "32n", tTime);
                    else if(t.id===5) t.player.triggerAttackRelease("G1", "32n", tTime);
                    else if(t.id===6) t.player.triggerAttackRelease("C5", "64n", tTime);
                    else if(t.id===7) t.player.triggerAttackRelease("C2", "64n", tTime);
                    else t.player.triggerAttackRelease("32n", tTime);
                }
            }
        }
    });

    Tone.Draw.schedule(() => {
        document.getElementById('beatMarker').style.transform = `translateX(${currentStep * (600/STEPS)}px)`;
    }, time);

    currentStep++;
    if(currentStep >= STEPS) {
        currentStep = 0;
        tracks.forEach(t => evolve(t));
        drawHistory();
    }
}

// --- FILE LOADERS ---

// 1. IR Loader
document.getElementById('irInput').addEventListener('change', (e) => {
    if(!actx) { alert("Please START ENGINE first to initialize Audio Context"); return; }
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = function(ev) {
        actx.decodeAudioData(ev.target.result, function(buffer) {
            convolverNode.buffer = buffer;
            document.getElementById('irStatus').style.display = 'block';
        });
    };
    reader.readAsArrayBuffer(file);
});

// 2. Sample Loader (Per Track)
function handleSampleLoad(trackId, file) {
    if(!actx) { alert("Please START ENGINE first"); return; }
    
    const url = URL.createObjectURL(file);
    const player = new Tone.Player(url, () => {
        console.log(`Track ${trackId} sample loaded.`);
        // Dispose old synth if exists
        if(tracks[trackId].player) tracks[trackId].player.dispose();
        
        // Assign new player and route it
        tracks[trackId].player = player;
        connectRoute(player);
    });
}

// --- VISUALS ---
const cvs = document.getElementById('historyCanvas');
const ctx = cvs.getContext('2d');
const buf = document.createElement('canvas');
buf.width = cvs.width; buf.height = cvs.height;
const bctx = buf.getContext('2d');
const rowH = 15;
const stepW = cvs.width / STEPS;

function drawHistory() {
    bctx.globalCompositeOperation = 'copy';
    bctx.drawImage(buf, 0, 0, cvs.width, cvs.height-rowH, 0, rowH, cvs.width, cvs.height-rowH);
    bctx.globalCompositeOperation = 'source-over';
    bctx.fillStyle = '#000';
    bctx.fillRect(0,0,cvs.width, rowH);
    
    for(let i=0; i<STEPS; i++) {
        let x = i*stepW;
        let subW = stepW/8;
        tracks.forEach((t, idx) => {
            if(t.world[i] > 0) {
                bctx.fillStyle = t.color;
                let h = (t.world[i]===6) ? rowH : rowH/2; 
                bctx.fillRect(x + (idx*subW), rowH-h, subW-1, h);
            }
        });
    }
    ctx.drawImage(buf, 0, 0);
}

// --- UI GENERATION ---
const tList = document.getElementById('trackList');
tracks.forEach(t => {
    let div = document.createElement('div');
    div.className = 'track-row';
    div.innerHTML = `
        <div class="track-color" style="background:${t.color}"></div>
        <span>${t.name}</span>
        <input type="file" accept="audio/*">
    `;
    div.querySelector('input').addEventListener('change', e => {
        if(e.target.files[0]) handleSampleLoad(t.id, e.target.files[0]);
    });
    tList.appendChild(div);
});

// BINDINGS
document.getElementById('playBtn').addEventListener('click', initAudio);
document.getElementById('sldLam').addEventListener('input', e=>{ params.lambda=e.target.value; tracks.forEach(t=>applyLambda(t)); });
document.getElementById('sldRev').addEventListener('input', e=>{ 
    params.reverb=e.target.value; 
    if(reverbGain) reverbGain.gain.value = params.reverb; 
});
document.getElementById('sldRatch').addEventListener('input', e=>{ params.ratchet=e.target.value; });
document.getElementById('sldBpm').addEventListener('input', e=>{ params.bpm=e.target.value; if(isPlaying) Tone.Transport.bpm.value=e.target.value; });

function scramble() { tracks.forEach(t => initTrack(t)); }
tracks.forEach(t => initTrack(t));
drawHistory();

</script>
</body>
</html>
